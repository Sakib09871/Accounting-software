<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Software</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <Style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
}

.container {
    display: flex;
}

.sidebar {
    width: 250px;
    background-color: #2c3e50;
    color: #fff;
    height: 100vh;
    position: fixed;
    overflow-y: auto;
}

.sidebar-header {
    padding: 20px;
    background-color: #1a252f;
    text-align: center;
}

.sidebar ul {
    list-style: none;
    padding: 20px;
}

.sidebar ul li {
    padding: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.sidebar ul li:hover {
    background-color: #34495e;
}

.sidebar label {
    padding: 20px;
    display: block;
}

.content {
    margin-left: 250px;
    padding: 20px;
    width: calc(100% - 250px);
}

.section {
    display: none;
}

.section.active {
    display: block;
}

h2 {
    margin-bottom: 20px;
    color: #2c3e50;
}

form {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

input, select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    pointer-events: auto; /* Ensure inputs and selects are clickable */
    cursor: pointer; /* Ensure cursor indicates interactivity */
}

input[type="file"] {
    padding: 3px;
}

button {
    padding: 10px 20px;
    background-color: #2c3e50;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

button:hover {
    background-color: #34495e;
}

table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #f2f2f2;
}

.action-icons span {
    cursor: pointer;
    color: #2c3e50;
    margin-right: 10px;
}

.action-icons span:hover {
    color: #e74c3c;
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.card {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.card h3 {
    margin-bottom: 10px;
    color: #2c3e50;
}

.notification {
    background-color: #e74c3c;
    color: #fff;
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 4px;
    display: none;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.buttons {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 20px;
}

.close-btn {
    background-color: #e74c3c;
}

.close-btn:hover {
    background-color: #c0392b;
}

.invoice-box {
    padding: 20px;
}

.invoice-logo img {
    max-width: 100px;
    margin-bottom: 20px;
}

.invoice-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.invoice-table th, .invoice-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.invoice-table th {
    background-color: #f2f2f2;
}

.report-stats {
    margin-bottom: 20px;
}

.report-stats p {
    margin: 5px 0;
}

#cheque-transactions-table tbody tr {
    color: #e74c3c; /* Red for uncleared cheques */
}

.android-mode .sidebar {
    width: 100px;
}

.android-mode .content {
    margin-left: 100px;
    width: calc(100% - 100px);
}

@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
    }
    
    .content {
        margin-left: 0;
        width: 100%;
    }
    
    .android-mode .sidebar {
        width: 100%;
    }
    
    .android-mode .content {
        margin-left: 0;
        width: 100%;
    }
}

/* Ensure ei-debtor-creditor dropdown is selectable */
#ei-debtor-creditor {
    width: 100%;
    padding: 8px;
    font-size: 16px;
    pointer-events: auto;
    cursor: pointer;
    background-color: #fff;
    border: 1px solid #ccc;
}

#ei-debtor-creditor:disabled {
    background-color: #f0f0f0;
    cursor: not-allowed;
}
    </Style>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Accounting Software</h2>
            </div>
            <ul>
                <li onclick="showSection('dashboard')">Dashboard (F1)</li>
                <li onclick="showSection('capital')">Capital (F2)</li>
                <li onclick="showSection('companies')">Companies (F3)</li>
                <li onclick="showSection('sale-item-list')">Sale Item List (F4)</li>
                <li onclick="showSection('purchase')">Purchase (F5)</li>
                <li onclick="showSection('sale')">Sale (F6)</li>
                <li onclick="showSection('ledger')">Ledger (F7)</li>
                <li onclick="showSection('expense-income')">Expense/Income (F8)</li>
                <li onclick="showSection('stock-alert')">Stock Alert (F9)</li>
                <li onclick="showSection('reports')">Reports (F10)</li>
                <li onclick="showSection('cheque-transactions')">Cheque Transactions (F11)</li>
                <li onclick="showSection('info')">Info (F12)</li>
            </ul>
            <label><input type="checkbox" id="android-mode"> Android Mode</label>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>Total Balance</h3>
                        <p id="total-balance">0.00</p>
                    </div>
                    <div class="card">
                        <h3>Total Profit</h3>
                        <p id="total-profit">0.00</p>
                    </div>
                    <div class="card">
                        <h3>Total Customers</h3>
                        <p id="total-customers">0</p>
                    </div>
                    <div class="card">
                        <h3>Total Items</h3>
                        <p id="total-items">0</p>
                    </div>
                    <div class="card">
                        <h3>Total Cash</h3>
                        <p id="total-cash">0.00</p>
                    </div>
                    <div class="card">
                        <h3>Total UPI</h3>
                        <p id="total-upi">0.00</p>
                    </div>
                    <div class="card">
                        <h3>Pending Cheques</h3>
                        <p id="pending-cheques">0</p>
                    </div>
                </div>
                <div id="stock-alert-notification" class="notification"></div>
                <h3>Item List</h3>
                <table id="item-list-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Stock</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Capital -->
            <div id="capital" class="section">
                <h2>Capital</h2>
                <form id="capital-form">
                    <label>Company Name</label>
                    <input type="text" id="capital-company-name" required>
                    <label>Contact Number</label>
                    <input type="text" id="capital-contact" required>
                    <label>Company Logo</label>
                    <input type="file" id="capital-logo" accept="image/*">
                    <label>GSTIN Number</label>
                    <input type="text" id="capital-gstin">
                    <label>IFSC Number</label>
                    <input type="text" id="capital-ifsc">
                    <label>Address</label>
                    <input type="text" id="capital-address" required>
                    <label>Country</label>
                    <input type="text" id="capital-country" required>
                    <label>State</label>
                    <input type="text" id="capital-state" required>
                    <label>State Code</label>
                    <input type="text" id="capital-state-code" required>
                    <label>Email ID</label>
                    <input type="email" id="capital-email" required>
                    <label>Account Number</label>
                    <input type="text" id="capital-account-number" required>
                    <label>Password</label>
                    <input type="password" id="capital-password" required>
                    <label>Amount</label>
                    <input type="number" id="capital-amount" required>
                    <button type="submit">Submit</button>
                    
                </form>
            </div>

            <!-- Companies -->
            <div id="companies" class="section">
                <h2>Companies</h2>
                <table id="companies-table">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sale Item List -->
            <div id="sale-item-list" class="section">
                <h2>Sale Item List</h2>
                <form id="sale-item-form">
                    <label>Item Name</label>
                    <input type="text" id="item-name" required>
                    <label>Supplier Name</label>
                    <input type="text" id="supplier-name" required>
                    <label>Supplier Contact Number</label>
                    <input type="text" id="supplier-contact" required>
                    <label>Supplier Address</label>
                    <input type="text" id="supplier-address" required>
                    <label>Type</label>
                    <input type="text" id="item-type" required>
                    <label>Unit</label>
                    <input type="text" id="item-unit" required>
                    <label>Category</label>
                    <input type="text" id="item-category" required>
                    <label>Purchase Rate</label>
                    <input type="number" id="purchase-rate" required>
                    <label>GST Rate</label>
                    <select id="gst-rate" required>
                        <option value="5">5%</option>
                        <option value="12">12%</option>
                        <option value="18">18%</option>
                        <option value="28">28%</option>
                    </select>
                    <label>CGST Rate</label>
                    <input type="number" id="cgst-rate" readonly>
                    <label>SGST Rate</label>
                    <input type="number" id="sgst-rate" readonly>
                    <label>Sale Rate</label>
                    <input type="number" id="sale-rate" readonly>
                    <button type="submit">Submit</button>
                </form>
                <table id="sale-item-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Supplier Name</th>
                            <th>Type</th>
                            <th>Unit</th>
                            <th>Category</th>
                            <th>Purchase Rate</th>
                            <th>Sale Rate</th>
                            <th>GST Rate</th>
                            <th>CGST Rate</th>
                            <th>SGST Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Purchase -->
            <div id="purchase" class="section">
                <h2>Purchase</h2>
                <form id="purchase-form">
                    <label>Item Name</label>
                    <select id="purchase-item-name" required>
                        <option value="">Select Item</option>
                    </select>
                    <label>Supplier Name</label>
                    <input type="text" id="purchase-supplier-name" readonly>
                    <label>Supplier Address</label>
                    <input type="text" id="purchase-supplier-address" readonly>
                    <label>Type</label>
                    <input type="text" id="purchase-type" readonly>
                    <label>Unit</label>
                    <input type="text" id="purchase-unit" readonly>
                    <label>Category</label>
                    <input type="text" id="purchase-category" readonly>
                    <label>Purchase Rate</label>
                    <input type="number" id="purchase-rate-display" readonly>
                    <label>Sale Rate</label>
                    <input type="number" id="purchase-sale-rate" readonly>
                    <label>GST Rate</label>
                    <input type="number" id="purchase-gst-rate" readonly>
                    <label>CGST Rate</label>
                    <input type="number" id="purchase-cgst-rate" readonly>
                    <label>SGST Rate</label>
                    <input type="number" id="purchase-sgst-rate" readonly>
                    <label>Quantity</label>
                    <input type="number" id="purchase-quantity" required>
                    <label>CGST Amount</label>
                    <input type="number" id="purchase-cgst-amount" readonly>
                    <label>SGST Amount</label>
                    <input type="number" id="purchase-sgst-amount" readonly>
                    <label>Total Amount</label>
                    <input type="number" id="purchase-total-amount" readonly>
                    <label>Currency</label>
                    <select id="purchase-currency" required>
                        <option value="INR">INR</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                    <label>Payment Method</label>
                    <select id="purchase-payment-method" required>
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="cheque">Cheque</option>
                        <option value="creditor">Creditor</option>
                    </select>
                    <div id="cheque-details-purchase" style="display: none;">
                        <label>Cheque Date</label>
                        <input type="date" id="purchase-cheque-date">
                        <label>Bank Name</label>
                        <input type="text" id="purchase-bank-name">
                        <label>Cheque Number</label>
                        <input type="text" id="purchase-cheque-number">
                    </div>
                    <label>Description</label>
                    <input type="text" id="purchase-description">
                    <label>Date</label>
                    <input type="date" id="purchase-date" required>
                    <button type="submit">Submit</button>
                </form>
                <table id="purchase-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Payment Method</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sale -->
            <div id="sale" class="section">
                <h2>Sale</h2>
                <form id="sale-form">
                    <label>Item Name</label>
                    <select id="sale-item-name" required>
                        <option value="">Select Item</option>
                    </select>
                    <label>Customer Name</label>
                    <input type="text" id="sale-customer-name" required>
                    <label>Customer Address</label>
                    <input type="text" id="sale-customer-address" required>
                    <label>Customer Contact</label>
                    <input type="text" id="sale-customer-contact" required>
                    <label>Type</label>
                    <input type="text" id="sale-type" readonly>
                    <label>Unit</label>
                    <input type="text" id="sale-unit" readonly>
                    <label>Category</label>
                    <input type="text" id="sale-category" readonly>
                    <label>Purchase Rate</label>
                    <input type="number" id="sale-purchase-rate" readonly>
                    <label>Sale Rate</label>
                    <input type="number" id="sale-sale-rate" readonly>
                    <label>GST Rate</label>
                    <input type="number" id="sale-gst-rate" readonly>
                    <label>CGST Rate</label>
                    <input type="number" id="sale-cgst-rate" readonly>
                    <label>SGST Rate</label>
                    <input type="number" id="sale-sgst-rate" readonly>
                    <label>Quantity</label>
                    <input type="number" id="sale-quantity" required>
                    <label>Discount</label>
                    <input type="checkbox" id="discount-checkbox">
                    <input type="number" id="sale-discount" disabled>
                    <label>CGST Amount</label>
                    <input type="number" id="sale-cgst-amount" readonly>
                    <label>SGST Amount</label>
                    <input type="number" id="sale-sgst-amount" readonly>
                    <label>Total Amount</label>
                    <input type="number" id="sale-total-amount" readonly>
                    <label>Currency</label>
                    <select id="sale-currency" required>
                        <option value="INR">INR</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                    <label>Payment Method</label>
                    <select id="sale-payment-method" required>
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="cheque">Cheque</option>
                        <option value="debtor">Debtor</option>
                    </select>
                    <div id="cheque-details-sale" style="display: none;">
                        <label>Cheque Date</label>
                        <input type="date" id="sale-cheque-date">
                        <label>Bank Name</label>
                        <input type="text" id="sale-bank-name">
                        <label>Cheque Number</label>
                        <input type="text" id="sale-cheque-number">
                    </div>
                    <label>Description</label>
                    <input type="text" id="sale-description">
                    <label>Date</label>
                    <input type="date" id="sale-date" required>
                    <button type="submit">Submit</button>
                </form>
                <table id="sale-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Customer Name</th>
                            <th>Quantity</th>
                            <th>Discount</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Payment Method</th>
                            <th>Date</th>
                            <th>Invoice Number</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Ledger -->
            <div id="ledger" class="section">
                <h2>Ledger</h2>
                <form id="ledger-form">
                    <label>Ledger Name</label>
                    <input type="text" id="ledger-name" required>
                    <label>Under</label>
                    <input type="text" id="ledger-under" required>
                    <button type="submit">Submit</button>
                </form>
                <table id="ledger-table">
                    <thead>
                        <tr>
                            <th>Ledger Name</th>
                            <th>Under</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Expense/Income -->
            <div id="expense-income" class="section">
                <h2>Expense/Income</h2>
                <form id="expense-income-form">
                    <label>Name</label>
                    <input type="text" id="ei-name" required>
                    <label>Ledger</label>
                    <select id="ei-ledger" required>
                        <option value="">Select Ledger</option>
                    </select>
                    <label>Type</label>
                    <select id="ei-type" required>
                        <option value="sale">Sale</option>
                        <option value="purchase">Purchase</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <label>Cr/Dr</label>
                    <select id="ei-cr-dr" required>
                        <option value="cr">Cr</option>
                        <option value="dr">Dr</option>
                    </select>
                    <label>Rate</label>
                    <input type="number" id="ei-rate" required>
                    <label>Currency</label>
                    <select id="ei-currency" required>
                        <option value="INR">INR</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                    <label>Debtor/Creditor</label>
                    <select id="ei-debtor-creditor">
                        <option value="">None</option>
                    </select>
                    <label>Payment Method</label>
                    <select id="ei-payment-method" required>
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="cheque">Cheque</option>
                    </select>
                    <button type="submit">Submit</button>
                </form>
                <table id="expense-income-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Ledger</th>
                            <th>Type</th>
                            <th>Cr/Dr</th>
                            <th>Rate</th>
                            <th>Currency</th>
                            <th>Debtor/Creditor</th>
                            <th>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Stock Alert -->
            <div id="stock-alert" class="section">
                <h2>Stock Alert</h2>
                <form id="stock-alert-form">
                    <label>Item Name</label>
                    <select id="alert-item-name" required>
                        <option value="">Select Item</option>
                    </select>
                    <label>Threshold</label>
                    <input type="number" id="alert-threshold" required>
                    <button type="submit">Submit</button>
                </form>
                <table id="stock-alert-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Threshold</th>
                            <th>Current Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Reports -->
            <div id="reports" class="section">
                <h2>Reports</h2>
                <label>Type</label>
                <select id="report-type" onchange="handleReportTypeChange()">
                    <option value="all">All</option>
                    <option value="purchase">Purchase</option>
                    <option value="sale">Sale</option>
                    <option value="debtor">Debtor</option>
                    <option value="creditor">Creditor</option>
                </select>
                <label>Time Frame</label>
                <select id="report-time-frame" onchange="handleReportTypeChange()">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom</option>
                </select>
                <div id="custom-date" style="display: none;">
                    <label>Start Date</label>
                    <input type="date" id="report-start-date">
                    <label>End Date</label>
                    <input type="date" id="report-end-date">
                </div>
                <button onclick="generateReport()">Generate Report</button>
                <div class="report-stats">
                    <p>Total Profit: <span id="report-total-profit">0.00</span></p>
                    <p>Total Sale: <span id="report-total-sale">0.00</span></p>
                    <p>Total Purchase: <span id="report-total-purchase">0.00</span></p>
                    <p>Total Creditors: <span id="report-total-creditors">0</span></p>
                    <p>Total Debtors: <span id="report-total-debtors">0</span></p>
                </div>
                <table id="report-purchase-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>Payment Method</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <table id="report-sale-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Customer Name</th>
                            <th>Quantity</th>
                            <th>Discount</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>Payment Method</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <table id="report-debtor-table">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <table id="report-creditor-table">
                    <thead>
                        <tr>
                            <th>Supplier Name</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Total Amount</th>
                            <th>Currency</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <table id="report-item-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Stock</th>
                            <th>Sold</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="all-reports-popup" class="modal">
                    <div class="modal-content">
                        <div class="buttons">
                            <button onclick="closePopup()">Close</button>
                        </div>
                        <h3>All Reports</h3>
                        <label>Date</label>
                        <input type="date" id="search-date">
                        <label>Item Name</label>
                        <input type="text" id="search-item">
                        <button onclick="searchAllReports()">Search</button>
                    </div>
                </div>
            </div>

            <!-- Cheque Transactions -->
            <div id="cheque-transactions" class="section">
                <h2>Cheque Transactions</h2>
                <table id="cheque-transactions-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Item/Customer</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Cheque Date</th>
                            <th>Bank Name</th>
                            <th>Cheque Number</th>
                            <th>Transaction Date</th>
                            <th>Time Elapsed</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Info -->
            <div id="info" class="section">
                <h2>Info</h2>
                <p>Accounting Software for managing capital, companies, items, purchases, sales, ledgers, expenses/incomes, stock alerts, and reports.</p>
                <p><strong>Shortcuts:</strong></p>
                <ul>
                    <li>F1: Dashboard</li>
                    <li>F2: Capital</li>
                    <li>F3: Companies</li>
                    <li>F4: Sale Item List</li>
                    <li>F5: Purchase</li>
                    <li>F6: Sale</li>
                    <li>F7: Ledger</li>
                    <li>F8: Expense/Income</li>
                    <li>F9: Stock Alert</li>
                    <li>F10: Reports</li>
                    <li>F11: Cheque Transactions</li>
                    <li>F12: Info</li>
                    <li>Ctrl + A: Toggle Android Mode</li>
                    <li>Ctrl + D: Delete Company (in Companies section)</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        // Data storage
let capital = null;
let companies = [];
let items = [];
let stock = {};
let stockAlerts = {};
let purchases = [];
let sales = [];
let ledgers = [];
let expenseIncome = [];
let balance = { cash: 0, upi: 0, cheque: 0 };
let debtors = new Set();
let creditors = new Set();
let chequeTransactions = [];
let invoiceCounter = 1;

// Load data from localStorage
function loadData() {
    const storedChequeTransactions = localStorage.getItem('chequeTransactions');
    if (storedChequeTransactions) {
        chequeTransactions = JSON.parse(storedChequeTransactions).map(tx => ({
            ...tx,
            transactionDate: new Date(tx.transactionDate)
        }));
    }
    const storedCapital = localStorage.getItem('capital');
    if (storedCapital) {
        capital = JSON.parse(storedCapital);
        balance.cash = capital.amount;
    }
    const storedCompanies = localStorage.getItem('companies');
    if (storedCompanies) {
        companies = JSON.parse(storedCompanies);
    }
    const storedItems = localStorage.getItem('items');
    if (storedItems) {
        items = JSON.parse(storedItems);
    }
    const storedStock = localStorage.getItem('stock');
    if (storedStock) {
        stock = JSON.parse(storedStock);
    }
    const storedStockAlerts = localStorage.getItem('stockAlerts');
    if (storedStockAlerts) {
        stockAlerts = JSON.parse(storedStockAlerts);
    }
    const storedPurchases = localStorage.getItem('purchases');
    if (storedPurchases) {
        purchases = JSON.parse(storedPurchases).map(p => ({ ...p, date: new Date(p.date) }));
    }
    const storedSales = localStorage.getItem('sales');
    if (storedSales) {
        sales = JSON.parse(storedSales).map(s => ({ ...s, date: new Date(s.date) }));
    }
    const storedLedgers = localStorage.getItem('ledgers');
    if (storedLedgers) {
        ledgers = JSON.parse(storedLedgers);
    }
    const storedExpenseIncome = localStorage.getItem('expenseIncome');
    if (storedExpenseIncome) {
        expenseIncome = JSON.parse(storedExpenseIncome);
    }
    const storedBalance = localStorage.getItem('balance');
    if (storedBalance) {
        balance = JSON.parse(storedBalance);
    }
    const storedDebtors = localStorage.getItem('debtors');
    if (storedDebtors) {
        debtors = new Set(JSON.parse(storedDebtors));
    }
    const storedCreditors = localStorage.getItem('creditors');
    if (storedCreditors) {
        creditors = new Set(JSON.parse(storedCreditors));
    }
    const storedInvoiceCounter = localStorage.getItem('invoiceCounter');
    if (storedInvoiceCounter) {
        invoiceCounter = parseInt(storedInvoiceCounter);
    }
}

// Save data to localStorage
function saveData() {
    localStorage.setItem('chequeTransactions', JSON.stringify(chequeTransactions));
    localStorage.setItem('capital', JSON.stringify(capital));
    localStorage.setItem('companies', JSON.stringify(companies));
    localStorage.setItem('items', JSON.stringify(items));
    localStorage.setItem('stock', JSON.stringify(stock));
    localStorage.setItem('stockAlerts', JSON.stringify(stockAlerts));
    localStorage.setItem('purchases', JSON.stringify(purchases));
    localStorage.setItem('sales', JSON.stringify(sales));
    localStorage.setItem('ledgers', JSON.stringify(ledgers));
    localStorage.setItem('expenseIncome', JSON.stringify(expenseIncome));
    localStorage.setItem('balance', JSON.stringify(balance));
    localStorage.setItem('debtors', JSON.stringify([...debtors]));
    localStorage.setItem('creditors', JSON.stringify([...creditors]));
    localStorage.setItem('invoiceCounter', invoiceCounter);
}

// Utility Functions
function showSection(sectionId) {
    if (!capital && sectionId !== 'capital' && sectionId !== 'info') {
        alert('Please add capital details first.');
        sectionId = 'capital';
    }
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(sectionId).classList.add('active');
}

function updateDashboard() {
    document.getElementById('total-balance').textContent = (balance.cash + balance.upi + balance.cheque).toFixed(2);
    document.getElementById('total-profit').textContent = (sales.reduce((sum, sale) => sum + sale.totalAmount, 0) + 
        purchases.reduce((sum, p) => sum + (['cash', 'upi'].includes(p.paymentMethod) ? -p.totalAmount : p.paymentMethod === 'creditor' ? p.totalAmount : 0), 0)).toFixed(2);
    document.getElementById('total-customers').textContent = new Set(sales.map(s => s.customerName)).size;
    document.getElementById('total-items').textContent = Object.keys(stock).length;
    document.getElementById('total-cash').textContent = balance.cash.toFixed(2);
    document.getElementById('total-upi').textContent = balance.upi.toFixed(2);
    document.getElementById('pending-cheques').textContent = chequeTransactions.filter(tx => !tx.cleared).length;

    const tbody = document.getElementById('item-list-table').querySelector('tbody');
    tbody.innerHTML = '';
    Object.keys(stock).forEach(itemName => {
        const row = tbody.insertRow();
        row.innerHTML = `<td>${itemName}</td><td>${stock[itemName].stock}</td>`;
    });
}

// Capital
document.getElementById('capital-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const logoInput = document.getElementById('capital-logo');
    const logo = logoInput.files[0] ? URL.createObjectURL(logoInput.files[0]) : '';
    capital = {
        companyName: document.getElementById('capital-company-name').value,
        contact: document.getElementById('capital-contact').value,
        logo,
        gstin: document.getElementById('capital-gstin').value,
        ifsc: document.getElementById('capital-ifsc').value,
        address: document.getElementById('capital-address').value,
        country: document.getElementById('capital-country').value,
        state: document.getElementById('capital-state').value,
        stateCode: document.getElementById('capital-state-code').value,
        email: document.getElementById('capital-email').value,
        accountNumber: document.getElementById('capital-account-number').value,
        password: document.getElementById('capital-password').value,
        amount: parseFloat(document.getElementById('capital-amount').value)
    };
    balance.cash = capital.amount;
    companies.push({
        companyName: capital.companyName,
        contact: capital.contact,
        logo: capital.logo,
        gstin: capital.gstin,
        ifsc: capital.ifsc,
        address: capital.address,
        country: capital.country,
        state: capital.state,
        stateCode: capital.stateCode,
        email: capital.email,
        accountNumber: capital.accountNumber
    });
    updateCompaniesTable();
    updateDashboard();
    this.reset();
    document.getElementById('capital-logo').value = ''; // Explicitly clear file input
    saveData();
    alert('Capital added successfully!');
});

// Companies
function updateCompaniesTable() {
    const tbody = document.getElementById('companies-table').querySelector('tbody');
    tbody.innerHTML = '';
    companies.forEach((company, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${company.companyName}</td>
            <td>
                Contact: ${company.contact}<br>
                Address: ${company.address}<br>
                GSTIN: ${company.gstin || 'N/A'}<br>
                IFSC: ${company.ifsc || 'N/A'}
            </td>
            <td class="action-icons">
                <span onclick="editCompany(${index})">Edit</span>
                <span onclick="deleteCompany(${index})">Delete</span>
            </td>
        `;
    });
}

function editCompany(index) {
    const password = prompt('Enter password to edit company:');
    if (password !== capital.password) {
        alert('Incorrect password!');
        return;
    }
    const company = companies[index];
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="buttons">
                <button class="close-btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <h3>Edit Company</h3>
            <form id="edit-company-form">
                <label>Company Name</label>
                <input type="text" value="${company.companyName}" id="edit-company-name" required>
                <label>Contact Number</label>
                <input type="text" value="${company.contact}" id="edit-contact" required>
                <label>Company Logo</label>
                <input type="file" id="edit-logo" accept="image/*">
                <label>GSTIN Number</label>
                <input type="text" value="${company.gstin || ''}" id="edit-gstin">
                <label>IFSC Number</label>
                <input type="text" value="${company.ifsc || ''}" id="edit-ifsc">
                <label>Address</label>
                <input type="text" value="${company.address}" id="edit-address" required>
                <label>Country</label>
                <input type="text" value="${company.country}" id="edit-country" required>
                <label>State</label>
                <input type="text" value="${company.state}" id="edit-state" required>
                <label>State Code</label>
                <input type="text" value="${company.stateCode}" id="edit-state-code" required>
                <label>Email ID</label>
                <input type="email" value="${company.email}" id="edit-email" required>
                <label>Account Number</label>
                <input type="text" value="${company.accountNumber}" id="edit-account-number" required>
                <button type="submit">Save</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#edit-company-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const logoInput = document.getElementById('edit-logo');
        companies[index] = {
            companyName: document.getElementById('edit-company-name').value,
            contact: document.getElementById('edit-contact').value,
            logo: logoInput.files[0] ? URL.createObjectURL(logoInput.files[0]) : company.logo,
            gstin: document.getElementById('edit-gstin').value,
            ifsc: document.getElementById('edit-ifsc').value,
            address: document.getElementById('edit-address').value,
            country: document.getElementById('edit-country').value,
            state: document.getElementById('edit-state').value,
            stateCode: document.getElementById('edit-state-code').value,
            email: document.getElementById('edit-email').value,
            accountNumber: document.getElementById('edit-account-number').value
        };
        updateCompaniesTable();
        this.reset();
        document.getElementById('edit-logo').value = ''; // Explicitly clear file input
        saveData();
        modal.remove();
        alert('Company updated successfully!');
    });
}

function deleteCompany(index) {
    if (confirm('Are you sure you want to delete this company?')) {
        if (confirm('Confirm deletion of this company.')) {
            companies.splice(index, 1);
            updateCompaniesTable();
            saveData();
            alert('Company deleted successfully!');
        }
    }
}

// Sale Item List
document.getElementById('gst-rate').addEventListener('change', function() {
    const gstRate = parseFloat(this.value);
    const purchaseRate = parseFloat(document.getElementById('purchase-rate').value) || 0;
    const cgstRate = gstRate / 2;
    const sgstRate = gstRate / 2;
    document.getElementById('cgst-rate').value = cgstRate.toFixed(2);
    document.getElementById('sgst-rate').value = sgstRate.toFixed(2);
    document.getElementById('sale-rate').value = (purchaseRate * 1.2 + purchaseRate * (gstRate / 100)).toFixed(2);
});

document.getElementById('sale-item-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const item = {
        name: document.getElementById('item-name').value,
        supplierName: document.getElementById('supplier-name').value,
        supplierContact: document.getElementById('supplier-contact').value,
        supplierAddress: document.getElementById('supplier-address').value,
        type: document.getElementById('item-type').value,
        unit: document.getElementById('item-unit').value,
        category: document.getElementById('item-category').value,
        purchaseRate: parseFloat(document.getElementById('purchase-rate').value),
        gstRate: parseFloat(document.getElementById('gst-rate').value),
        cgstRate: parseFloat(document.getElementById('cgst-rate').value),
        sgstRate: parseFloat(document.getElementById('sgst-rate').value),
        saleRate: parseFloat(document.getElementById('sale-rate').value)
    };
    items.push(item);
    stock[item.name] = { stock: 0, sold: 0 };
    updateSaleItemTable();
    updatePurchaseItemSelect();
    updateSaleItemSelect();
    updateAlertItemSelect();
    updateDashboard();
    this.reset();
    document.getElementById('cgst-rate').value = '';
    document.getElementById('sgst-rate').value = '';
    document.getElementById('sale-rate').value = '';
    saveData();
    alert('Item added successfully!');
});

function updateSaleItemTable() {
    const tbody = document.getElementById('sale-item-table').querySelector('tbody');
    tbody.innerHTML = '';
    items.forEach((item, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.supplierName}</td>
            <td>${item.type}</td>
            <td>${item.unit}</td>
            <td>${item.category}</td>
            <td>${item.purchaseRate.toFixed(2)}</td>
            <td>${item.saleRate.toFixed(2)}</td>
            <td>${item.gstRate}%</td>
            <td>${item.cgstRate}%</td>
            <td>${item.sgstRate}%</td>
            <td class="action-icons">
                <span onclick="editSaleItem(${index})">Edit</span>
                <span onclick="deleteSaleItem(${index})">Delete</span>
            </td>
        `;
    });
}

function editSaleItem(index) {
    const item = items[index];
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="buttons">
                <button class="close-btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <h3>Edit Item</h3>
            <form id="edit-item-form">
                <label>Item Name</label>
                <input type="text" value="${item.name}" id="edit-item-name" required>
                <label>Supplier Name</label>
                <input type="text" value="${item.supplierName}" id="edit-supplier-name" required>
                <label>Supplier Contact Number</label>
                <input type="text" value="${item.supplierContact}" id="edit-supplier-contact" required>
                <label>Supplier Address</label>
                <input type="text" value="${item.supplierAddress}" id="edit-supplier-address" required>
                <label>Type</label>
                <input type="text" value="${item.type}" id="edit-item-type" required>
                <label>Unit</label>
                <input type="text" value="${item.unit}" id="edit-item-unit" required>
                <label>Category</label>
                <input type="text" value="${item.category}" id="edit-item-category" required>
                <label>Purchase Rate</label>
                <input type="number" value="${item.purchaseRate}" id="edit-purchase-rate" required>
                <label>GST Rate</label>
                <select id="edit-gst-rate" required>
                    <option value="5" ${item.gstRate === 5 ? 'selected' : ''}>5%</option>
                    <option value="12" ${item.gstRate === 12 ? 'selected' : ''}>12%</option>
                    <option value="18" ${item.gstRate === 18 ? 'selected' : ''}>18%</option>
                    <option value="28" ${item.gstRate === 28 ? 'selected' : ''}>28%</option>
                </select>
                <label>CGST Rate</label>
                <input type="number" value="${item.cgstRate}" id="edit-cgst-rate" readonly>
                <label>SGST Rate</label>
                <input type="number" value="${item.sgstRate}" id="edit-sgst-rate" readonly>
                <label>Sale Rate</label>
                <input type="number" value="${item.saleRate}" id="edit-sale-rate" readonly>
                <button type="submit">Save</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    const gstSelect = modal.querySelector('#edit-gst-rate');
    const purchaseRateInput = modal.querySelector('#edit-purchase-rate');
    const cgstRateInput = modal.querySelector('#edit-cgst-rate');
    const sgstRateInput = modal.querySelector('#edit-sgst-rate');
    const saleRateInput = modal.querySelector('#edit-sale-rate');
    
    function updateRates() {
        const gstRate = parseFloat(gstSelect.value);
        const purchaseRate = parseFloat(purchaseRateInput.value) || 0;
        const cgstRate = gstRate / 2;
        const sgstRate = gstRate / 2;
        cgstRateInput.value = cgstRate.toFixed(2);
        sgstRateInput.value = sgstRate.toFixed(2);
        saleRateInput.value = (purchaseRate * 1.2 + purchaseRate * (gstRate / 100)).toFixed(2);
    }
    
    gstSelect.addEventListener('change', updateRates);
    purchaseRateInput.addEventListener('input', updateRates);
    
    modal.querySelector('#edit-item-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const oldName = items[index].name;
        items[index] = {
            name: document.getElementById('edit-item-name').value,
            supplierName: document.getElementById('edit-supplier-name').value,
            supplierContact: document.getElementById('edit-supplier-contact').value,
            supplierAddress: document.getElementById('edit-supplier-address').value,
            type: document.getElementById('edit-item-type').value,
            unit: document.getElementById('edit-item-unit').value,
            category: document.getElementById('edit-item-category').value,
            purchaseRate: parseFloat(document.getElementById('edit-purchase-rate').value),
            gstRate: parseFloat(document.getElementById('edit-gst-rate').value),
            cgstRate: parseFloat(document.getElementById('edit-cgst-rate').value),
            sgstRate: parseFloat(document.getElementById('edit-sgst-rate').value),
            saleRate: parseFloat(document.getElementById('edit-sale-rate').value)
        };
        if (oldName !== items[index].name) {
            stock[items[index].name] = stock[oldName] || { stock: 0, sold: 0 };
            delete stock[oldName];
            if (stockAlerts[oldName]) {
                stockAlerts[items[index].name] = stockAlerts[oldName];
                delete stockAlerts[oldName];
            }
            purchases.forEach(p => {
                if (p.itemName === oldName) p.itemName = items[index].name;
            });
            sales.forEach(s => {
                if (s.itemName === oldName) s.itemName = items[index].name;
            });
            chequeTransactions.forEach(tx => {
                if (tx.itemName === oldName) tx.itemName = items[index].name;
            });
        }
        updateSaleItemTable();
        updatePurchaseItemSelect();
        updateSaleItemSelect();
        updateAlertItemSelect();
        updateStockAlertTable();
        updateChequeTransactionsTable();
        updateDashboard();
        checkStockAlerts();
        this.reset();
        saveData();
        modal.remove();
        alert('Item updated successfully!');
    });
}

function deleteSaleItem(index) {
    if (confirm(`Are you sure you want to delete ${items[index].name}?`)) {
        const itemName = items[index].name;
        items.splice(index, 1);
        delete stock[itemName];
        delete stockAlerts[itemName];
        updateSaleItemTable();
        updatePurchaseItemSelect();
        updateSaleItemSelect();
        updateAlertItemSelect();
        updateStockAlertTable();
        updateChequeTransactionsTable();
        updateDashboard();
        checkStockAlerts();
        saveData();
        alert('Item deleted successfully!');
    }
}

// Purchase
function updatePurchaseItemSelect() {
    const select = document.getElementById('purchase-item-name');
    select.innerHTML = '<option value="">Select Item</option>';
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

document.getElementById('purchase-item-name').addEventListener('change', function() {
    const itemName = this.value;
    const item = items.find(i => i.name === itemName);
    if (item) {
        document.getElementById('purchase-supplier-name').value = item.supplierName;
        document.getElementById('purchase-supplier-address').value = item.supplierAddress;
        document.getElementById('purchase-type').value = item.type;
        document.getElementById('purchase-unit').value = item.unit;
        document.getElementById('purchase-category').value = item.category;
        document.getElementById('purchase-rate-display').value = item.purchaseRate.toFixed(2);
        document.getElementById('purchase-sale-rate').value = item.saleRate.toFixed(2);
        document.getElementById('purchase-gst-rate').value = item.gstRate.toFixed(2);
        document.getElementById('purchase-cgst-rate').value = item.cgstRate.toFixed(2);
        document.getElementById('purchase-sgst-rate').value = item.sgstRate.toFixed(2);
        updatePurchaseAmounts();
    } else {
        document.getElementById('purchase-supplier-name').value = '';
        document.getElementById('purchase-supplier-address').value = '';
        document.getElementById('purchase-type').value = '';
        document.getElementById('purchase-unit').value = '';
        document.getElementById('purchase-category').value = '';
        document.getElementById('purchase-rate-display').value = '';
        document.getElementById('purchase-sale-rate').value = '';
        document.getElementById('purchase-gst-rate').value = '';
        document.getElementById('purchase-cgst-rate').value = '';
        document.getElementById('purchase-sgst-rate').value = '';
        document.getElementById('purchase-cgst-amount').value = '';
        document.getElementById('purchase-sgst-amount').value = '';
        document.getElementById('purchase-total-amount').value = '';
    }
});

document.getElementById('purchase-quantity').addEventListener('input', updatePurchaseAmounts);

function updatePurchaseAmounts() {
    const quantity = parseFloat(document.getElementById('purchase-quantity').value) || 0;
    const purchaseRate = parseFloat(document.getElementById('purchase-rate-display').value) || 0;
    const gstRate = parseFloat(document.getElementById('purchase-gst-rate').value) || 0;
    const cgstAmount = (purchaseRate * quantity * (gstRate / 2 / 100)).toFixed(2);
    const sgstAmount = (purchaseRate * quantity * (gstRate / 2 / 100)).toFixed(2);
    const totalAmount = (purchaseRate * quantity + parseFloat(cgstAmount) + parseFloat(sgstAmount)).toFixed(2);
    document.getElementById('purchase-cgst-amount').value = cgstAmount;
    document.getElementById('purchase-sgst-amount').value = sgstAmount;
    document.getElementById('purchase-total-amount').value = totalAmount;
}

document.getElementById('purchase-payment-method').addEventListener('change', function() {
    document.getElementById('cheque-details-purchase').style.display = this.value === 'cheque' ? 'block' : 'none';
});

document.getElementById('purchase-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const itemName = document.getElementById('purchase-item-name').value;
    const quantity = parseInt(document.getElementById('purchase-quantity').value);
    const totalAmount = parseFloat(document.getElementById('purchase-total-amount').value);
    const paymentMethod = document.getElementById('purchase-payment-method').value;
    
    if (!itemName || quantity <= 0) {
        alert('Please select an item and enter a valid quantity.');
        return;
    }
    
    if (['cash', 'upi'].includes(paymentMethod) && totalAmount > (balance[paymentMethod] || 0)) {
        alert(`Insufficient ${paymentMethod} balance!`);
        return;
    }
    
    const purchase = {
        itemName,
        description: document.getElementById('purchase-description').value,
        quantity,
        totalAmount,
        cgstAmount: parseFloat(document.getElementById('purchase-cgst-amount').value),
        sgstAmount: parseFloat(document.getElementById('purchase-sgst-amount').value),
        currency: document.getElementById('purchase-currency').value,
        paymentMethod,
        date: new Date(document.getElementById('purchase-date').value)
    };
    
    if (paymentMethod === 'cheque') {
        const chequeDate = document.getElementById('purchase-cheque-date').value;
        const bankName = document.getElementById('purchase-bank-name').value;
        const chequeNumber = document.getElementById('purchase-cheque-number').value;
        if (!chequeDate || !bankName || !chequeNumber) {
            alert('Please fill in all cheque details.');
            return;
        }
        chequeTransactions.push({
            type: 'Purchase',
            itemName,
            amount: totalAmount,
            currency: purchase.currency,
            chequeDate,
            bankName,
            chequeNumber,
            transactionDate: new Date(),
            cleared: false
        });
    }
    
    purchases.push(purchase);
    stock[itemName].stock += quantity;
    if (paymentMethod === 'creditor') {
        creditors.add(itemName);
    } else if (['cash', 'upi'].includes(paymentMethod)) {
        balance[paymentMethod] -= totalAmount;
    }
    updatePurchaseTable();
    updateChequeTransactionsTable();
    updateDebtorCreditorSelect();
    updateDashboard();
    checkStockAlerts();
    this.reset();
    document.getElementById('purchase-item-name').value = '';
    document.getElementById('purchase-supplier-name').value = '';
    document.getElementById('purchase-supplier-address').value = '';
    document.getElementById('purchase-type').value = '';
    document.getElementById('purchase-unit').value = '';
    document.getElementById('purchase-category').value = '';
    document.getElementById('purchase-rate-display').value = '';
    document.getElementById('purchase-sale-rate').value = '';
    document.getElementById('purchase-gst-rate').value = '';
    document.getElementById('purchase-cgst-rate').value = '';
    document.getElementById('purchase-sgst-rate').value = '';
    document.getElementById('purchase-cgst-amount').value = '';
    document.getElementById('purchase-sgst-amount').value = '';
    document.getElementById('purchase-total-amount').value = '';
    document.getElementById('cheque-details-purchase').style.display = 'none';
    document.getElementById('purchase-cheque-date').value = '';
    document.getElementById('purchase-bank-name').value = '';
    document.getElementById('purchase-cheque-number').value = '';
    saveData();
    alert('Purchase recorded successfully!');
});

function updatePurchaseTable() {
    const tbody = document.getElementById('purchase-table').querySelector('tbody');
    tbody.innerHTML = '';
    purchases.forEach(purchase => {
        const row = tbody.insertRow();
        const displayAmount = ['cash', 'upi'].includes(purchase.paymentMethod) ? -purchase.totalAmount : purchase.totalAmount;
        row.innerHTML = `
            <td>${purchase.itemName}</td>
            <td>${purchase.quantity}</td>
            <td>${displayAmount.toFixed(2)}</td>
            <td>${purchase.currency}</td>
            <td>${purchase.cgstAmount.toFixed(2)}</td>
            <td>${purchase.sgstAmount.toFixed(2)}</td>
            <td>${purchase.paymentMethod}</td>
            <td>${purchase.date.toISOString().split('T')[0]}</td>
        `;
    });
}

// Sale
function updateSaleItemSelect() {
    const select = document.getElementById('sale-item-name');
    select.innerHTML = '<option value="">Select Item</option>';
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

document.getElementById('sale-item-name').addEventListener('change', function() {
    const itemName = this.value;
    const item = items.find(i => i.name === itemName);
    if (item) {
        document.getElementById('sale-type').value = item.type;
        document.getElementById('sale-unit').value = item.unit;
        document.getElementById('sale-category').value = item.category;
        document.getElementById('sale-purchase-rate').value = item.purchaseRate.toFixed(2);
        document.getElementById('sale-sale-rate').value = item.saleRate.toFixed(2);
        document.getElementById('sale-gst-rate').value = item.gstRate.toFixed(2);
        document.getElementById('sale-cgst-rate').value = item.cgstRate.toFixed(2);
        document.getElementById('sale-sgst-rate').value = item.sgstRate.toFixed(2);
        updateSaleAmounts();
    } else {
        document.getElementById('sale-type').value = '';
        document.getElementById('sale-unit').value = '';
        document.getElementById('sale-category').value = '';
        document.getElementById('sale-purchase-rate').value = '';
        document.getElementById('sale-sale-rate').value = '';
        document.getElementById('sale-gst-rate').value = '';
        document.getElementById('sale-cgst-rate').value = '';
        document.getElementById('sale-sgst-rate').value = '';
        document.getElementById('sale-cgst-amount').value = '';
        document.getElementById('sale-sgst-amount').value = '';
        document.getElementById('sale-total-amount').value = '';
    }
});

document.getElementById('sale-quantity').addEventListener('input', updateSaleAmounts);
document.getElementById('sale-discount').addEventListener('input', updateSaleAmounts);
document.getElementById('discount-checkbox').addEventListener('change', function() {
    document.getElementById('sale-discount').disabled = !this.checked;
    updateSaleAmounts();
});

document.getElementById('sale-payment-method').addEventListener('change', function() {
    document.getElementById('cheque-details-sale').style.display = this.value === 'cheque' ? 'block' : 'none';
});

function updateSaleAmounts() {
    const quantity = parseFloat(document.getElementById('sale-quantity').value) || 0;
    const saleRate = parseFloat(document.getElementById('sale-sale-rate').value) || 0;
    const gstRate = parseFloat(document.getElementById('sale-gst-rate').value) || 0;
    const discount = document.getElementById('discount-checkbox').checked ? parseFloat(document.getElementById('sale-discount').value) || 0 : 0;
    const cgstAmount = (saleRate * quantity * (gstRate / 2 / 100)).toFixed(2);
    const sgstAmount = (saleRate * quantity * (gstRate / 2 / 100)).toFixed(2);
    const baseAmount = saleRate * quantity;
    const discountedAmount = baseAmount * (1 - discount / 100);
    const totalAmount = (discountedAmount + parseFloat(cgstAmount) + parseFloat(sgstAmount)).toFixed(2);
    document.getElementById('sale-cgst-amount').value = cgstAmount;
    document.getElementById('sale-sgst-amount').value = sgstAmount;
    document.getElementById('sale-total-amount').value = totalAmount;
}

document.getElementById('sale-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const itemName = document.getElementById('sale-item-name').value;
    const quantity = parseInt(document.getElementById('sale-quantity').value);
    const totalAmount = parseFloat(document.getElementById('sale-total-amount').value);
    const paymentMethod = document.getElementById('sale-payment-method').value;
    
    if (!itemName || quantity <= 0) {
        alert('Please select an item and enter a valid quantity.');
        return;
    }
    
    if (quantity > stock[itemName].stock) {
        alert('Insufficient stock!');
        return;
    }
    
    const sale = {
        itemName,
        description: document.getElementById('sale-description').value,
        customerName: document.getElementById('sale-customer-name').value,
        customerAddress: document.getElementById('sale-customer-address').value,
        customerContact: document.getElementById('sale-customer-contact').value,
        quantity,
        discount: document.getElementById('discount-checkbox').checked ? parseFloat(document.getElementById('sale-discount').value) || 0 : 0,
        totalAmount,
        cgstAmount: parseFloat(document.getElementById('sale-cgst-amount').value),
        sgstAmount: parseFloat(document.getElementById('sale-sgst-amount').value),
        currency: document.getElementById('sale-currency').value,
        paymentMethod,
        date: new Date(document.getElementById('sale-date').value),
        invoiceNumber: `INV-${invoiceCounter.toString().padStart(4, '0')}`
    };
    
    if (paymentMethod === 'cheque') {
        const chequeDate = document.getElementById('sale-cheque-date').value;
        const bankName = document.getElementById('sale-bank-name').value;
        const chequeNumber = document.getElementById('sale-cheque-number').value;
        if (!chequeDate || !bankName || !chequeNumber) {
            alert('Please fill in all cheque details.');
            return;
        }
        chequeTransactions.push({
            type: 'Sale',
            itemName: sale.customerName,
            amount: totalAmount,
            currency: sale.currency,
            chequeDate,
            bankName,
            chequeNumber,
            transactionDate: new Date(),
            cleared: false,
            invoiceNumber: sale.invoiceNumber
        });
    }
    
    sales.push(sale);
    invoiceCounter++;
    stock[itemName].stock -= quantity;
    stock[itemName].sold += quantity;
    if (paymentMethod === 'debtor') {
        debtors.add(sale.customerName);
    } else if (['cash', 'upi'].includes(paymentMethod)) {
        balance[paymentMethod] += totalAmount;
    }
    updateSaleTable();
    updateChequeTransactionsTable();
    updateDebtorCreditorSelect();
    updateDashboard();
    checkStockAlerts();
    this.reset();
    document.getElementById('sale-item-name').value = '';
    document.getElementById('sale-type').value = '';
    document.getElementById('sale-unit').value = '';
    document.getElementById('sale-category').value = '';
    document.getElementById('sale-purchase-rate').value = '';
    document.getElementById('sale-sale-rate').value = '';
    document.getElementById('sale-gst-rate').value = '';
    document.getElementById('sale-cgst-rate').value = '';
    document.getElementById('sale-sgst-rate').value = '';
    document.getElementById('sale-cgst-amount').value = '';
    document.getElementById('sale-sgst-amount').value = '';
    document.getElementById('sale-total-amount').value = '';
    document.getElementById('sale-discount').value = '';
    document.getElementById('sale-discount').disabled = true;
    document.getElementById('discount-checkbox').checked = false;
    document.getElementById('cheque-details-sale').style.display = 'none';
    document.getElementById('sale-cheque-date').value = '';
    document.getElementById('sale-bank-name').value = '';
    document.getElementById('sale-cheque-number').value = '';
    saveData();
    alert('Sale recorded successfully!');
});

function updateSaleTable() {
    const tbody = document.getElementById('sale-table').querySelector('tbody');
    tbody.innerHTML = '';
    sales.forEach((sale, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${sale.itemName}</td>
            <td>${sale.customerName}</td>
            <td>${sale.quantity}</td>
            <td>${sale.discount}%</td>
            <td>${sale.totalAmount.toFixed(2)}</td>
            <td>${sale.currency}</td>
            <td>${sale.cgstAmount.toFixed(2)}</td>
            <td>${sale.sgstAmount.toFixed(2)}</td>
            <td>${sale.paymentMethod}</td>
            <td>${sale.date.toISOString().split('T')[0]}</td>
            <td>${sale.invoiceNumber}</td>
            <td><span class="action-icons" onclick="generateInvoice(${index})">Invoice</span></td>
        `;
    });
}

function generateInvoice(index) {
    const sale = sales[index];
    const item = items.find(i => i.name === sale.itemName);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="buttons no-print">
                <button onclick="downloadInvoice()">Download PDF</button>
                <button class="close-btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <div class="invoice-box">
                <div class="invoice-logo">
                    ${capital.logo ? `<img src="${capital.logo}" alt="Company Logo">` : ''}
                </div>
                <h3>Invoice</h3>
                <p><strong>Invoice Number:</strong> ${sale.invoiceNumber}</p>
                <p><strong>Company:</strong> ${capital.companyName}</p>
                <p><strong>Address:</strong> ${capital.address}, ${capital.state}, ${capital.country}</p>
                <p><strong>GSTIN:</strong> ${capital.gstin || 'N/A'}</p>
                <p><strong>Contact:</strong> ${capital.contact}</p>
                <hr>
                <p><strong>Customer:</strong> ${sale.customerName}</p>
                <p><strong>Address:</strong> ${sale.customerAddress}</p>
                <p><strong>Contact:</strong> ${sale.customerContact}</p>
                <p><strong>Date:</strong> ${sale.date.toISOString().split('T')[0]}</p>
                <hr>
                <h4>Items</h4>
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Discount</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${sale.itemName}</td>
                            <td>${sale.quantity}</td>
                            <td>${item.saleRate.toFixed(2)} ${sale.currency}</td>
                            <td>${sale.discount}%</td>
                            <td>${sale.cgstAmount.toFixed(2)}</td>
                            <td>${sale.sgstAmount.toFixed(2)}</td>
                            <td>${sale.totalAmount.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
                <hr>
                <p><strong>Total Amount:</strong> ${sale.totalAmount.toFixed(2)} ${sale.currency}</p>
                <p><strong>Payment Method:</strong> ${sale.paymentMethod}</p>
                <p><strong>Description:</strong> ${sale.description || 'N/A'}</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

/*
NOTE FOR PDF DOWNLOAD:
For the "Download PDF" button to work correctly, please add the following CSS to your stylesheet.
This CSS ensures that when you print, only the invoice is visible, and the "Download" and "Close" buttons are hidden.
The browser's "Print" dialog will allow you to "Save as PDF".

@media print {
  body > .section, body > .sidebar, body > #stock-alert-notification, body > script {
    display: none;
  }
  body > .modal {
    display: block !important;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background-color: white;
    box-shadow: none;
    border: none;
  }
  .modal-content {
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 0;
  }
  .no-print {
    display: none !important;
  }
}
*/
function downloadInvoice() {
    window.print();
}


// Ledger
document.getElementById('ledger-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const ledger = {
        name: document.getElementById('ledger-name').value,
        under: document.getElementById('ledger-under').value
    };
    ledgers.push(ledger);
    updateLedgerTable();
    updateExpenseIncomeLedgerSelect();
    this.reset();
    saveData();
    alert('Ledger added successfully!');
});

function updateLedgerTable() {
    const tbody = document.getElementById('ledger-table').querySelector('tbody');
    tbody.innerHTML = '';
    ledgers.forEach((ledger, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${ledger.name}</td>
            <td>${ledger.under}</td>
            <td class="action-icons">
                <span onclick="editLedger(${index})">Edit</span>
                <span onclick="deleteLedger(${index})">Delete</span>
            </td>
        `;
    });
}

function editLedger(index) {
    const ledger = ledgers[index];
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="buttons">
                <button class="close-btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <h3>Edit Ledger</h3>
            <form id="edit-ledger-form">
                <label>Ledger Name</label>
                <input type="text" value="${ledger.name}" id="edit-ledger-name" required>
                <label>Under</label>
                <input type="text" value="${ledger.under}" id="edit-ledger-under" required>
                <button type="submit">Save</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#edit-ledger-form').addEventListener('submit', function(e) {
        e.preventDefault();
        ledgers[index] = {
            name: document.getElementById('edit-ledger-name').value,
            under: document.getElementById('edit-ledger-under').value
        };
        updateLedgerTable();
        updateExpenseIncomeLedgerSelect();
        this.reset();
        saveData();
        modal.remove();
        alert('Ledger updated successfully!');
    });
}

function deleteLedger(index) {
    if (confirm(`Are you sure you want to delete ${ledgers[index].name}?`)) {
        ledgers.splice(index, 1);
        updateLedgerTable();
        updateExpenseIncomeLedgerSelect();
        saveData();
        alert('Ledger deleted successfully!');
    }
}

// Expense/Income
function updateExpenseIncomeLedgerSelect() {
    const select = document.getElementById('ei-ledger');
    select.innerHTML = '<option value="">Select Ledger</option>';
    ledgers.forEach(ledger => {
        const option = document.createElement('option');
        option.value = ledger.name;
        option.textContent = ledger.name;
        select.appendChild(option);
    });
}

function updateDebtorCreditorSelect() {
    const select = document.getElementById('ei-debtor-creditor');
    select.innerHTML = '<option value="">None</option>';
    debtors.forEach(debtor => {
        const option = document.createElement('option');
        option.value = `Debtor: ${debtor}`;
        option.textContent = `Debtor: ${debtor}`;
        select.appendChild(option);
    });
    creditors.forEach(creditor => {
        const option = document.createElement('option');
        option.value = `Creditor: ${creditor}`;
        option.textContent = `Creditor: ${creditor}`;
        select.appendChild(option);
    });
    chequeTransactions.forEach((tx, index) => {
        if (!tx.cleared) {
            const option = document.createElement('option');
            option.value = `Cheque: ${index}`;
            option.textContent = `Cheque: ${tx.chequeNumber} (${tx.type})`;
            select.appendChild(option);
        }
    });
}

document.getElementById('ei-debtor-creditor').addEventListener('change', function() {
    const select = document.getElementById('ei-payment-method');
    const value = this.value;
    select.innerHTML = `
        <option value="cash">Cash</option>
        <option value="upi">UPI</option>
        ${!value.startsWith('Cheque: ') ? '<option value="cheque">Cheque</option>' : ''}
    `;
});

document.getElementById('expense-income-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const ei = {
        name: document.getElementById('ei-name').value,
        ledger: document.getElementById('ei-ledger').value,
        type: document.getElementById('ei-type').value,
        crDr: document.getElementById('ei-cr-dr').value,
        rate: parseFloat(document.getElementById('ei-rate').value),
        currency: document.getElementById('ei-currency').value,
        debtorCreditor: document.getElementById('ei-debtor-creditor').value,
        paymentMethod: document.getElementById('ei-payment-method').value
    };
    
    if (!ei.name || !ei.ledger || !ei.type || !ei.crDr || isNaN(ei.rate) || !ei.currency || !ei.paymentMethod) {
        alert('Please fill in all required fields.');
        return;
    }

    if (['cash', 'upi'].includes(ei.paymentMethod) && ei.rate > (balance[ei.paymentMethod] || 0) && ei.crDr === 'dr') {
        alert(`Insufficient ${ei.paymentMethod} balance!`);
        return;
    }
    
    if (ei.debtorCreditor.startsWith('Cheque: ')) {
        const chequeIndex = parseInt(ei.debtorCreditor.replace('Cheque: ', ''));
        const cheque = chequeTransactions[chequeIndex];
        if (!cheque) {
            alert('Invalid cheque selected.');
            return;
        }
        if (cheque.cleared) {
            alert('Cheque already cleared.');
            return;
        }
        if ((cheque.type === 'Sale' && ei.crDr !== 'cr') || (cheque.type === 'Purchase' && ei.crDr !== 'dr')) {
            alert(`Cheque clearance for ${cheque.type} must be ${cheque.type === 'Sale' ? 'Cr' : 'Dr'}.`);
            return;
        }
        if (ei.rate !== cheque.amount || ei.currency !== cheque.currency) {
            alert('Rate and currency must match the cheque details.');
            return;
        }
        cheque.cleared = true;
        if (cheque.type === 'Sale' && ei.crDr === 'cr') {
            balance[ei.paymentMethod] += ei.rate;
        } else if (cheque.type === 'Purchase' && ei.crDr === 'dr') {
            balance[ei.paymentMethod] -= ei.rate;
        }
    }
    
    if (ei.debtorCreditor.startsWith('Debtor: ')) {
        debtors.delete(ei.debtorCreditor.replace('Debtor: ', ''));
    } else if (ei.debtorCreditor.startsWith('Creditor: ')) {
        creditors.delete(ei.debtorCreditor.replace('Creditor: ', ''));
    }
    
    if (!ei.debtorCreditor.startsWith('Cheque: ')) {
        if (ei.crDr === 'cr') {
            balance[ei.paymentMethod] += ei.rate;
        } else {
            balance[ei.paymentMethod] -= ei.rate;
        }
    }
    
    expenseIncome.push(ei);
    updateExpenseIncomeTable();
    updateDebtorCreditorSelect();
    updateChequeTransactionsTable();
    updateDashboard();
    this.reset();
    document.getElementById('ei-debtor-creditor').value = '';
    document.getElementById('ei-payment-method').innerHTML = `
        <option value="cash">Cash</option>
        <option value="upi">UPI</option>
        <option value="cheque">Cheque</option>
    `;
    saveData();
    alert('Expense/Income recorded successfully!');
});

function updateExpenseIncomeTable() {
    const tbody = document.getElementById('expense-income-table').querySelector('tbody');
    tbody.innerHTML = '';
    expenseIncome.forEach(ei => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${ei.name}</td>
            <td>${ei.ledger}</td>
            <td>${ei.type}</td>
            <td>${ei.crDr}</td>
            <td>${ei.rate.toFixed(2)}</td>
            <td>${ei.currency}</td>
            <td>${ei.debtorCreditor || 'N/A'}</td>
            <td>${ei.paymentMethod}</td>
        `;
    });
}

// Stock Alert
function updateAlertItemSelect() {
    const select = document.getElementById('alert-item-name');
    select.innerHTML = '<option value="">Select Item</option>';
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

document.getElementById('stock-alert-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const itemName = document.getElementById('alert-item-name').value;
    const threshold = parseInt(document.getElementById('alert-threshold').value);
    
    if (!itemName || isNaN(threshold) || threshold < 1) {
        alert('Please select an item and enter a valid threshold.');
        return;
    }

    stockAlerts[itemName] = threshold;
    updateStockAlertTable();
    checkStockAlerts();
    this.reset();
    document.getElementById('alert-item-name').value = '';
    saveData();
    alert('Stock alert set successfully!');
});

function updateStockAlertTable() {
    const tbody = document.getElementById('stock-alert-table').querySelector('tbody');
    tbody.innerHTML = '';
    Object.keys(stockAlerts).forEach(itemName => {
        const threshold = stockAlerts[itemName];
        const currentStock = stock[itemName] ? stock[itemName].stock : 0;
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${itemName}</td>
            <td>${threshold}</td>
            <td>${currentStock}</td>
            <td class="action-icons">
                <span onclick="deleteStockAlert('${itemName}')">Delete</span>
            </td>
        `;
    });
}

function deleteStockAlert(itemName) {
    if (confirm(`Are you sure you want to delete the stock alert for ${itemName}?`)) {
        delete stockAlerts[itemName];
        updateStockAlertTable();
        checkStockAlerts();
        saveData();
        alert('Stock alert deleted successfully!');
    }
}

function checkStockAlerts() {
    const notification = document.getElementById('stock-alert-notification');
    let alertMessages = [];
    Object.keys(stockAlerts).forEach(itemName => {
        const threshold = stockAlerts[itemName];
        const currentStock = stock[itemName] ? stock[itemName].stock : 0;
        if (currentStock <= threshold) {
            alertMessages.push(`${itemName}: Stock (${currentStock}) is below threshold (${threshold})`);
        }
    });
    if (alertMessages.length > 0) {
        notification.textContent = alertMessages.join(' | ');
        notification.style.display = 'block';
    } else {
        notification.style.display = 'none';
    }
}

// Cheque Transactions
function formatTimeElapsed(transactionDate) {
    const now = new Date();
    const diff = now - transactionDate;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m`;
    if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

function updateChequeTransactionsTable() {
    const tbody = document.getElementById('cheque-transactions-table').querySelector('tbody');
    tbody.innerHTML = '';
    chequeTransactions.forEach((tx, index) => {
        if (!tx.cleared) {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${tx.type}</td>
                <td>${tx.itemName}</td>
                <td>${tx.amount.toFixed(2)}</td>
                <td>${tx.currency}</td>
                <td>${tx.chequeDate}</td>
                <td>${tx.bankName}</td>
                <td>${tx.chequeNumber}</td>
                <td>${tx.transactionDate.toISOString().split('T')[0]}</td>
                <td>${formatTimeElapsed(tx.transactionDate)}</td>
            `;
        }
    });
}

// Reports
function handleReportTypeChange() {
    const reportType = document.getElementById('report-type').value;
    const timeFrame = document.getElementById('report-time-frame').value;
    const customDateDiv = document.getElementById('custom-date');
    customDateDiv.style.display = timeFrame === 'custom' ? 'block' : 'none';
    
    document.getElementById('report-purchase-table').style.display = reportType === 'purchase' || reportType === 'all' ? 'table' : 'none';
    document.getElementById('report-sale-table').style.display = reportType === 'sale' || reportType === 'all' ? 'table' : 'none';
    document.getElementById('report-debtor-table').style.display = reportType === 'debtor' || reportType === 'all' ? 'table' : 'none';
    document.getElementById('report-creditor-table').style.display = reportType === 'creditor' || reportType === 'all' ? 'table' : 'none';
    document.getElementById('all-reports-popup').style.display = reportType === 'all' ? 'flex' : 'none';
}

function getDateRange() {
    const timeFrame = document.getElementById('report-time-frame').value;
    let startDate, endDate = new Date();
    if (timeFrame === 'today') {
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
    } else if (timeFrame === 'week') {
        startDate = new Date();
        startDate.setDate(endDate.getDate() - 7);
    } else if (timeFrame === 'month') {
        startDate = new Date();
        startDate.setMonth(endDate.getMonth() - 1);
    } else if (timeFrame === 'year') {
        startDate = new Date();
        startDate.setFullYear(endDate.getFullYear() - 1);
    } else if (timeFrame === 'custom') {
        startDate = new Date(document.getElementById('report-start-date').value);
        endDate = new Date(document.getElementById('report-end-date').value);
    }
    return { startDate, endDate };
}

function generateReport() {
    const { startDate, endDate } = getDateRange();
    let totalProfit = 0, totalSale = 0, totalPurchase = 0;
    
    // Purchase Table
    const purchaseTbody = document.getElementById('report-purchase-table').querySelector('tbody');
    purchaseTbody.innerHTML = '';
    purchases.forEach(purchase => {
        if (purchase.date >= startDate && purchase.date <= endDate) {
            const row = purchaseTbody.insertRow();
            const displayAmount = ['cash', 'upi'].includes(purchase.paymentMethod) ? -purchase.totalAmount : purchase.totalAmount;
            row.innerHTML = `
                <td>${purchase.itemName}</td>
                <td>${purchase.quantity}</td>
                <td>${displayAmount.toFixed(2)}</td>
                <td>${purchase.currency}</td>
                <td>${purchase.paymentMethod}</td>
                <td>${purchase.date.toISOString().split('T')[0]}</td>
            `;
            totalPurchase += displayAmount;
        }
    });

    // Sale Table
    const saleTbody = document.getElementById('report-sale-table').querySelector('tbody');
    saleTbody.innerHTML = '';
    sales.forEach((sale, index) => {
        if (sale.date >= startDate && sale.date <= endDate) {
            const row = saleTbody.insertRow();
            row.innerHTML = `
                <td>${sale.itemName}</td>
                <td>${sale.customerName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.discount}%</td>
                <td>${sale.totalAmount.toFixed(2)}</td>
                <td>${sale.currency}</td>
                <td>${sale.paymentMethod}</td>
                <td>${sale.date.toISOString().split('T')[0]}</td>
            `;
            totalSale += sale.totalAmount;
        }
    });

    // Debtor Table
    const debtorTbody = document.getElementById('report-debtor-table').querySelector('tbody');
    debtorTbody.innerHTML = '';
    sales.forEach((sale, index) => {
        if (sale.paymentMethod === 'debtor' && sale.date >= startDate && sale.date <= endDate) {
            const row = debtorTbody.insertRow();
            row.innerHTML = `
                <td>${sale.customerName}</td>
                <td>${sale.itemName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.totalAmount.toFixed(2)}</td>
                <td>${sale.currency}</td>
                <td>${sale.date.toISOString().split('T')[0]}</td>
                <td><span class="action-icons" onclick="generateInvoice(${index})">Invoice</span></td>
            `;
        }
    });

    // Creditor Table
    const creditorTbody = document.getElementById('report-creditor-table').querySelector('tbody');
    creditorTbody.innerHTML = '';
    purchases.forEach(purchase => {
        if (purchase.paymentMethod === 'creditor' && purchase.date >= startDate && purchase.date <= endDate) {
            const item = items.find(i => i.name === purchase.itemName);
            const row = creditorTbody.insertRow();
            row.innerHTML = `
                <td>${item ? item.supplierName : 'N/A'}</td>
                <td>${purchase.itemName}</td>
                <td>${purchase.quantity}</td>
                <td>${purchase.totalAmount.toFixed(2)}</td>
                <td>${purchase.currency}</td>
                <td>${purchase.date.toISOString().split('T')[0]}</td>
            `;
        }
    });

    // Item Stock Table
    const itemTbody = document.getElementById('report-item-table').querySelector('tbody');
    itemTbody.innerHTML = '';
    Object.keys(stock).forEach(itemName => {
        const row = itemTbody.insertRow();
        row.innerHTML = `
            <td>${itemName}</td>
            <td>${stock[itemName].stock}</td>
            <td>${stock[itemName].sold}</td>
        `;
    });

    // Update stats
    totalProfit = totalSale + totalPurchase;
    document.getElementById('report-total-profit').textContent = totalProfit.toFixed(2);
    document.getElementById('report-total-sale').textContent = totalSale.toFixed(2);
    document.getElementById('report-total-purchase').textContent = totalPurchase.toFixed(2);
    document.getElementById('report-total-creditors').textContent = creditors.size;
    document.getElementById('report-total-debtors').textContent = debtors.size;
}

function closePopup() {
    document.getElementById('all-reports-popup').style.display = 'none';
}

function searchAllReports() {
    const searchDate = new Date(document.getElementById('search-date').value);
    const searchItem = document.getElementById('search-item').value.toLowerCase();
    
    const purchaseTbody = document.getElementById('report-purchase-table').querySelector('tbody');
    purchaseTbody.innerHTML = '';
    purchases.forEach(purchase => {
        if ((!searchDate || purchase.date.toISOString().split('T')[0] === searchDate.toISOString().split('T')[0]) &&
            (!searchItem || purchase.itemName.toLowerCase().includes(searchItem))) {
            const row = purchaseTbody.insertRow();
            const displayAmount = ['cash', 'upi'].includes(purchase.paymentMethod) ? -purchase.totalAmount : purchase.totalAmount;
            row.innerHTML = `
                <td>${purchase.itemName}</td>
                <td>${purchase.quantity}</td>
                <td>${displayAmount.toFixed(2)}</td>
                <td>${purchase.currency}</td>
                <td>${purchase.paymentMethod}</td>
                <td>${purchase.date.toISOString().split('T')[0]}</td>
            `;
        }
    });

    const saleTbody = document.getElementById('report-sale-table').querySelector('tbody');
    saleTbody.innerHTML = '';
    sales.forEach((sale, index) => {
        if ((!searchDate || sale.date.toISOString().split('T')[0] === searchDate.toISOString().split('T')[0]) &&
            (!searchItem || sale.itemName.toLowerCase().includes(searchItem))) {
            const row = saleTbody.insertRow();
            row.innerHTML = `
                <td>${sale.itemName}</td>
                <td>${sale.customerName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.discount}%</td>
                <td>${sale.totalAmount.toFixed(2)}</td>
                <td>${sale.currency}</td>
                <td>${sale.paymentMethod}</td>
                <td>${sale.date.toISOString().split('T')[0]}</td>
            `;
        }
    });

    const debtorTbody = document.getElementById('report-debtor-table').querySelector('tbody');
    debtorTbody.innerHTML = '';
    sales.forEach((sale, index) => {
        if (sale.paymentMethod === 'debtor' &&
            (!searchDate || sale.date.toISOString().split('T')[0] === searchDate.toISOString().split('T')[0]) &&
            (!searchItem || sale.itemName.toLowerCase().includes(searchItem))) {
            const row = debtorTbody.insertRow();
            row.innerHTML = `
                <td>${sale.customerName}</td>
                <td>${sale.itemName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.totalAmount.toFixed(2)}</td>
                <td>${sale.currency}</td>
                <td>${sale.date.toISOString().split('T')[0]}</td>
                <td><span class="action-icons" onclick="generateInvoice(${index})">Invoice</span></td>
            `;
        }
    });

    const creditorTbody = document.getElementById('report-creditor-table').querySelector('tbody');
    creditorTbody.innerHTML = '';
    purchases.forEach(purchase => {
        if (purchase.paymentMethod === 'creditor' &&
            (!searchDate || purchase.date.toISOString().split('T')[0] === searchDate.toISOString().split('T')[0]) &&
            (!searchItem || purchase.itemName.toLowerCase().includes(searchItem))) {
            const item = items.find(i => i.name === purchase.itemName);
            const row = creditorTbody.insertRow();
            row.innerHTML = `
                <td>${item ? item.supplierName : 'N/A'}</td>
                <td>${purchase.itemName}</td>
                <td>${purchase.quantity}</td>
                <td>${purchase.totalAmount.toFixed(2)}</td>
                <td>${purchase.currency}</td>
                <td>${purchase.date.toISOString().split('T')[0]}</td>
            `;
        }
    });
}

function viewDebtors() {
    document.getElementById('report-type').value = 'debtor';
    handleReportTypeChange();
    generateReport();
}

function viewCreditors() {
    document.getElementById('report-type').value = 'creditor';
    handleReportTypeChange();
    generateReport();
}

// Timer for Cheque Transactions
function startTimer() {
    setInterval(() => {
        updateChequeTransactionsTable();
    }, 1000);
}

// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'd' && document.getElementById('companies').classList.contains('active')) {
        e.preventDefault();
        const index = prompt('Enter the index of the company to delete:');
        if (index !== null && !isNaN(index)) {
            deleteCompany(parseInt(index));
        }
    } else if (e.ctrlKey && e.key === 'a') {
        e.preventDefault();
        const androidMode = document.getElementById('android-mode');
        androidMode.checked = !androidMode.checked;
        document.querySelector('.sidebar').classList.toggle('android-mode', androidMode.checked);
        document.querySelector('.content').classList.toggle('android-mode', androidMode.checked);
    } else if (e.key.startsWith('F')) {
        const functionKeys = {
            'F1': 'dashboard',
            'F2': 'capital',
            'F3': 'companies',
            'F4': 'sale-item-list',
            'F5': 'purchase',
            'F6': 'sale',
            'F7': 'ledger',
            'F8': 'expense-income',
            'F9': 'stock-alert',
            'F10': 'reports',
            'F11': 'cheque-transactions',
            'F12': 'info'
        };
        const sectionId = functionKeys[e.key];
        if (sectionId) {
            e.preventDefault();
            showSection(sectionId);
        }
    }
});

// Initialize
loadData();
document.getElementById('report-time-frame').addEventListener('change', handleReportTypeChange);
updateCompaniesTable();
updateSaleItemTable();
updatePurchaseItemSelect();
updateSaleItemSelect();
updateAlertItemSelect();
updateLedgerTable();
updateExpenseIncomeLedgerSelect();
updateDebtorCreditorSelect();
updatePurchaseTable();
updateSaleTable();
updateStockAlertTable();
updateChequeTransactionsTable();
updateDashboard();
checkStockAlerts();
startTimer();
    </script>
</body>
</html>
      

